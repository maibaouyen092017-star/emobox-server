<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EmoBox</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
 <!-- Thanh Ä‘iá»u hÆ°á»›ng -->
<header class="navbar">
 <div class="logo">
  <img src="/logo.jpg" alt="Logo" class="logo-img">
  <span>EmoBox-Gáº¯n káº¿t yÃªu thÆ°Æ¡ng</span>
</div>
  <div id="user-info" class="user-info">
    <button id="loginBtn" class="btn-primary">ÄÄƒng nháº­p</button>
    <button id="registerBtn" class="btn-outline">ÄÄƒng kÃ½</button>
  </div>
</header>

<!-- Form ÄÄƒng nháº­p -->
<div id="login-modal" class="modal hidden">
  <div class="modal-content">
    <h3>ÄÄƒng nháº­p EmoBox</h3>
    <input type="text" id="login-username" placeholder="TÃªn Ä‘Äƒng nháº­p" />
    <input type="password" id="login-password" placeholder="Máº­t kháº©u" />
    <button id="doLogin">ÄÄƒng nháº­p</button>
    <p>ChÆ°a cÃ³ tÃ i khoáº£n? <a href="#" id="switchToRegister">ÄÄƒng kÃ½</a></p>
  </div>
</div>

<!-- Form ÄÄƒng kÃ½ -->
<div id="register-modal" class="modal hidden">
  <div class="modal-content">
    <h3>ÄÄƒng kÃ½ tÃ i khoáº£n má»›i</h3>
    <input type="text" id="reg-username" placeholder="TÃªn Ä‘Äƒng nháº­p" />
    <input type="password" id="reg-password" placeholder="Máº­t kháº©u" />
    <button id="doRegister">Táº¡o tÃ i khoáº£n</button>
    <p>ÄÃ£ cÃ³ tÃ i khoáº£n? <a href="#" id="switchToLogin">ÄÄƒng nháº­p</a></p>
  </div>
</div>


  <main>
    <section class="card">
      <h3>ğŸ¤ Gá»­i lá»i nháº¯n ngay (Realtime)</h3>
      <button id="recordBtn" class="red">ğŸ™ï¸ Ghi Ã¢m ngay</button>
      <button id="stopBtn" class="gray">â¹ï¸ Dá»«ng</button>
      <input id="msgTitle" placeholder="TiÃªu Ä‘á» (vÃ­ dá»¥: Lá»i chÃºc)">
      <button id="sendBtn" class="green">ğŸ“¤ Gá»­i ngay</button>
      <audio id="audioPlayer" controls></audio>
    </section>

    <section class="card">
      <h3>â° Äáº·t bÃ¡o thá»©c báº±ng giá»ng nÃ³i</h3>
      <input id="alarmDate" type="date">
      <input id="alarmTime" type="time">
      <input id="alarmTitle" placeholder="TÃªn bÃ¡o thá»©c (VD: Ä‚n sÃ¡ng)">
      <button id="alarmRecordBtn" class="yellow">ğŸ™ï¸ Ghi Ã¢m cho bÃ¡o thá»©c</button>
      <button id="alarmStopBtn" class="gray">â¹ï¸ Dá»«ng</button>
      <button id="saveAlarmBtn" class="blue">ğŸ’¾ LÆ°u bÃ¡o thá»©c</button>
      <audio id="alarmAudio" controls></audio>
    </section>

    <section class="card">
      <h3>ğŸ”” Lá»‹ch & Tin nháº¯n cá»§a báº¡n</h3>
      <div id="messageList"></div>
    </section>

    <section class="card">
      <h3>ğŸ“˜ HÆ°á»›ng dáº«n sá»­ dá»¥ng</h3>
      <p>- Ghi Ã¢m vÃ  gá»­i tin nháº¯n: chá»n "Gá»­i lá»i nháº¯n ngay", thu Ã¢m, nghe láº¡i vÃ  gá»­i.<br>
      - Äáº·t bÃ¡o thá»©c báº±ng giá»ng nÃ³i: chá»n ngÃ y, giá», ghi Ã¢m lá»i nháº¯c.<br>
      - ESP sáº½ phÃ¡t láº¡i tin nháº¯n/bÃ¡o thá»©c khi Ä‘áº¿n giá».<br>
      - Cáº§n Ä‘Äƒng nháº­p Ä‘á»ƒ lÆ°u lá»‹ch sá»­ vÃ  gá»­i voice.</p>
    </section>
  </main>

  <footer>
    <p>Â©2025-Mai PhÆ°á»›c Gia Báº£o- Dá»± Ã¡n khoa há»c kÄ© thuáº­t</p>
  </footer>
  <script>
  const recordBtn = document.getElementById("recordBtn");
  const stopBtn = document.getElementById("stopBtn");
  const sendBtn = document.getElementById("sendBtn");
  const audioPreview = document.getElementById("audioPreview");

  let mediaRecorder;
  let audioChunks = [];

  // âœ… Kiá»ƒm tra Ä‘Äƒng nháº­p (vÃ­ dá»¥ lÆ°u token trong localStorage)
  const token = localStorage.getItem("token");

  async function startRecording() {
    if (!token) {
      alert("âš ï¸ Vui lÃ²ng Ä‘Äƒng nháº­p Ä‘á»ƒ ghi Ã¢m!");
      return;
    }

    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);

    mediaRecorder.ondataavailable = (event) => {
      audioChunks.push(event.data);
    };

    mediaRecorder.onstop = () => {
      const blob = new Blob(audioChunks, { type: "audio/wav" });
      const url = URL.createObjectURL(blob);
      audioPreview.src = url;
      audioPreview.controls = true;
      audioPreview.load();
    };

    audioChunks = [];
    mediaRecorder.start();
    recordBtn.disabled = true;
    stopBtn.disabled = false;
  }

  function stopRecording() {
    mediaRecorder.stop();
    recordBtn.disabled = false;
    stopBtn.disabled = true;
  }

  async function sendRecording() {
    if (!token) {
      alert("âš ï¸ Báº¡n cáº§n Ä‘Äƒng nháº­p Ä‘á»ƒ gá»­i voice!");
      return;
    }

    const blob = new Blob(audioChunks, { type: "audio/wav" });
    const formData = new FormData();
    formData.append("file", blob, "voice.wav");

    const res = await fetch("/api/upload", {
      method: "POST",
      headers: {
        Authorization: `Bearer ${token}`,
      },
      body: formData,
    });

    const data = await res.json();
    if (res.ok) {
      alert("âœ… ÄÃ£ gá»­i voice thÃ nh cÃ´ng!");
    } else {
      alert("âŒ Lá»—i gá»­i file: " + data.message);
    }
  }

  recordBtn.addEventListener("click", startRecording);
  stopBtn.addEventListener("click", stopRecording);
  sendBtn.addEventListener("click", sendRecording);
</script>

  <script defer src="/script.js"></script>
</body>
</html>
