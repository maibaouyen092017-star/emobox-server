<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EmoBox</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
 <!-- Thanh điều hướng -->
<header class="navbar">
 <div class="logo">
  <img src="/logo.jpg" alt="Logo" class="logo-img">
  <span>EmoBox-Gắn kết yêu thương</span>
</div>
  <div id="user-info" class="user-info">
    <button id="loginBtn" class="btn-primary">Đăng nhập</button>
    <button id="registerBtn" class="btn-outline">Đăng ký</button>
  </div>
</header>

<!-- Form Đăng nhập -->
<div id="login-modal" class="modal hidden">
  <div class="modal-content">
    <h3>Đăng nhập EmoBox</h3>
    <input type="text" id="login-username" placeholder="Tên đăng nhập" />
    <input type="password" id="login-password" placeholder="Mật khẩu" />
    <button id="doLogin">Đăng nhập</button>
    <p>Chưa có tài khoản? <a href="#" id="switchToRegister">Đăng ký</a></p>
  </div>
</div>

<!-- Form Đăng ký -->
<div id="register-modal" class="modal hidden">
  <div class="modal-content">
    <h3>Đăng ký tài khoản mới</h3>
    <input type="text" id="reg-username" placeholder="Tên đăng nhập" />
    <input type="password" id="reg-password" placeholder="Mật khẩu" />
    <button id="doRegister">Tạo tài khoản</button>
    <p>Đã có tài khoản? <a href="#" id="switchToLogin">Đăng nhập</a></p>
  </div>
</div>


  <main>
    <section class="card">
      <h3>🎤 Gửi lời nhắn ngay (Realtime)</h3>
      <button id="recordBtn" class="red">🎙️ Ghi âm ngay</button>
      <button id="stopBtn" class="gray">⏹️ Dừng</button>
      <input id="msgTitle" placeholder="Tiêu đề (ví dụ: Lời chúc)">
      <button id="sendBtn" class="green">📤 Gửi ngay</button>
      <audio id="audioPlayer" controls></audio>
    </section>

    <section class="card">
      <h3>⏰ Đặt báo thức bằng giọng nói</h3>
      <input id="alarmDate" type="date">
      <input id="alarmTime" type="time">
      <input id="alarmTitle" placeholder="Tên báo thức (VD: Ăn sáng)">
      <button id="alarmRecordBtn" class="yellow">🎙️ Ghi âm cho báo thức</button>
      <button id="alarmStopBtn" class="gray">⏹️ Dừng</button>
      <button id="saveAlarmBtn" class="blue">💾 Lưu báo thức</button>
      <audio id="alarmAudio" controls></audio>
    </section>

    <section class="card">
      <h3>🔔 Lịch & Tin nhắn của bạn</h3>
      <div id="messageList"></div>
    </section>

    <section class="card">
      <h3>📘 Hướng dẫn sử dụng</h3>
      <p>- Ghi âm và gửi tin nhắn: chọn "Gửi lời nhắn ngay", thu âm, nghe lại và gửi.<br>
      - Đặt báo thức bằng giọng nói: chọn ngày, giờ, ghi âm lời nhắc.<br>
      - ESP sẽ phát lại tin nhắn/báo thức khi đến giờ.<br>
      - Cần đăng nhập để lưu lịch sử và gửi voice.</p>
    </section>
  </main>

  <footer>
    <p>©2025-Mai Phước Gia Bảo- Dự án khoa học kĩ thuật</p>
  </footer>
  <script>
  const recordBtn = document.getElementById("recordBtn");
  const stopBtn = document.getElementById("stopBtn");
  const sendBtn = document.getElementById("sendBtn");
  const audioPreview = document.getElementById("audioPreview");

  let mediaRecorder;
  let audioChunks = [];

  // ✅ Kiểm tra đăng nhập (ví dụ lưu token trong localStorage)
  const token = localStorage.getItem("token");

  async function startRecording() {
    if (!token) {
      alert("⚠️ Vui lòng đăng nhập để ghi âm!");
      return;
    }

    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);

    mediaRecorder.ondataavailable = (event) => {
      audioChunks.push(event.data);
    };

    mediaRecorder.onstop = () => {
      const blob = new Blob(audioChunks, { type: "audio/wav" });
      const url = URL.createObjectURL(blob);
      audioPreview.src = url;
      audioPreview.controls = true;
      audioPreview.load();
    };

    audioChunks = [];
    mediaRecorder.start();
    recordBtn.disabled = true;
    stopBtn.disabled = false;
  }

  function stopRecording() {
    mediaRecorder.stop();
    recordBtn.disabled = false;
    stopBtn.disabled = true;
  }

  async function sendRecording() {
    if (!token) {
      alert("⚠️ Bạn cần đăng nhập để gửi voice!");
      return;
    }

    const blob = new Blob(audioChunks, { type: "audio/wav" });
    const formData = new FormData();
    formData.append("file", blob, "voice.wav");

    const res = await fetch("/api/upload", {
      method: "POST",
      headers: {
        Authorization: `Bearer ${token}`,
      },
      body: formData,
    });

    const data = await res.json();
    if (res.ok) {
      alert("✅ Đã gửi voice thành công!");
    } else {
      alert("❌ Lỗi gửi file: " + data.message);
    }
  }

  recordBtn.addEventListener("click", startRecording);
  stopBtn.addEventListener("click", stopRecording);
  sendBtn.addEventListener("click", sendRecording);
</script>

  <script defer src="/script.js"></script>
</body>
</html>
