<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EmoBox</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* Nếu bạn không dùng Tailwind, thêm CSS ẩn/hiện cơ bản */
    .hidden { display: none; }
    #authModal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 999;
    }
    #authModal .box {
      background: white;
      padding: 20px;
      border-radius: 12px;
      width: 350px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }
    #authModal input {
      width: 100%;
      padding: 8px;
      margin: 6px 0;
    }
    #authModal button {
      width: 100%;
      margin-top: 8px;
      padding: 8px;
    }
  </style>
</head>
<body>

  <!-- ✅ Thanh điều hướng -->
  <header class="navbar">
    <div class="logo">
      <img src="/logo.jpg" alt="Logo" class="logo-img">
      <span>EmoBox - Gắn kết yêu thương</span>
    </div>
    <div id="user-info" class="user-info">
      <button id="loginBtn" class="btn-primary">Đăng nhập</button>
      <button id="registerBtn" class="btn-outline">Đăng ký</button>
      <button id="logoutBtn" class="btn-gray hidden">Đăng xuất</button>
    </div>
  </header>

  <!-- ✅ Modal đăng nhập / đăng ký -->
  <div id="authModal" class="hidden">
    <div class="box">
      <h2 id="authTitle" class="text-xl font-bold mb-4">Đăng nhập</h2>
      <input type="text" id="authUsername" placeholder="Tên đăng nhập" />
      <input type="password" id="authPassword" placeholder="Mật khẩu" />
      <button id="submitAuth" class="bg-blue-600 text-white">Xác nhận</button>
      <button id="closeAuth">Đóng</button>
    </div>
  </div>

  <main>
    <section class="card">
      <h3>🎤 Gửi lời nhắn ngay (Realtime)</h3>
      <button id="recordBtn" class="red">🎙️ Ghi âm ngay</button>
      <button id="stopBtn" class="gray">⏹️ Dừng</button>
      <input id="msgTitle" placeholder="Tiêu đề (ví dụ: Lời chúc)">
      <button id="sendBtn" class="green">📤 Gửi ngay</button>
      <audio id="audioPlayer" controls></audio>
    </section>

    <section class="card">
      <h3>⏰ Đặt báo thức bằng giọng nói</h3>
      <input id="alarmDate" type="date">
      <input id="alarmTime" type="time">
      <input id="alarmTitle" placeholder="Tên báo thức (VD: Ăn sáng)">
      <button id="alarmRecordBtn" class="yellow">🎙️ Ghi âm cho báo thức</button>
      <button id="alarmStopBtn" class="gray">⏹️ Dừng</button>
      <button id="saveAlarmBtn" class="blue">💾 Lưu báo thức</button>
      <audio id="alarmAudio" controls></audio>
    </section>

    <section class="card">
      <h3>🔔 Lịch & Tin nhắn của bạn</h3>
      <div id="messageList"></div>
    </section>

    <section class="card">
      <h3>📘 Hướng dẫn sử dụng</h3>
      <p>
        - Ghi âm và gửi tin nhắn: chọn "Gửi lời nhắn ngay", thu âm, nghe lại và gửi.<br>
        - Đặt báo thức bằng giọng nói: chọn ngày, giờ, ghi âm lời nhắc.<br>
        - ESP sẽ phát lại tin nhắn/báo thức khi đến giờ.<br>
        - Cần đăng nhập để lưu lịch sử và gửi voice.
      </p>
    </section>
  </main>

  <footer>
    <p>©2025 - Mai Phước Gia Bảo - Dự án khoa học kỹ thuật</p>
  </footer>

  <!-- ✅ Script xử lý đăng nhập / đăng ký -->
  <script>
  const API_URL = "https://emobox-server.onrender.com";

  const loginBtn = document.getElementById("loginBtn");
  const registerBtn = document.getElementById("registerBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const modal = document.getElementById("authModal");
  const authTitle = document.getElementById("authTitle");
  const username = document.getElementById("authUsername");
  const password = document.getElementById("authPassword");
  const submitAuth = document.getElementById("submitAuth");
  const closeAuth = document.getElementById("closeAuth");

  let currentMode = "login"; // login / register

  // mở form đăng nhập
  loginBtn.addEventListener("click", () => {
    modal.classList.remove("hidden");
    authTitle.textContent = "Đăng nhập";
    currentMode = "login";
  });

  // mở form đăng ký
  registerBtn.addEventListener("click", () => {
    modal.classList.remove("hidden");
    authTitle.textContent = "Đăng ký";
    currentMode = "register";
  });

  // đóng modal
  closeAuth.addEventListener("click", () => modal.classList.add("hidden"));

  // gửi dữ liệu
  submitAuth.addEventListener("click", async () => {
    const body = {
      username: username.value.trim(),
      password: password.value.trim(),
    };
    if (!body.username || !body.password) {
      alert("Vui lòng nhập đầy đủ thông tin!");
      return;
    }

    const endpoint = currentMode === "login" ? "/auth/login" : "/auth/register";

    try {
      const res = await fetch(API_URL + endpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
      });
      const data = await res.json();

      if (data.success) {
        alert(currentMode === "login" ? "Đăng nhập thành công!" : "Đăng ký thành công!");
        modal.classList.add("hidden");
        localStorage.setItem("token", data.token || "");
        loginBtn.classList.add("hidden");
        registerBtn.classList.add("hidden");
        logoutBtn.classList.remove("hidden");
      } else {
        alert(data.message || "Có lỗi xảy ra!");
      }
    } catch (err) {
      console.error(err);
      alert("Không thể kết nối server!");
    }
  });

  // đăng xuất
  logoutBtn.addEventListener("click", () => {
    localStorage.removeItem("token");
    alert("Đã đăng xuất!");
    logoutBtn.classList.add("hidden");
    loginBtn.classList.remove("hidden");
    registerBtn.classList.remove("hidden");
  });
  </script>

</body>
</html>
