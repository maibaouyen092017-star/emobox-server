<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EmoBox - Gắn kết yêu thương</title>
  <link rel="stylesheet" href="style.css" />

  <style>
    .hidden { display: none; }

    /* Modal nền */
    #authModal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 999;
    }
    #authModal .box {
      background: white;
      padding: 20px;
      border-radius: 12px;
      width: 350px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
    }
    #authModal input {
      width: 100%;
      padding: 8px;
      margin: 6px 0;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    #authModal button {
      width: 100%;
      margin-top: 8px;
      padding: 8px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    #authModal button:hover {
      opacity: 0.9;
    }
    header.navbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #0052cc;
      color: white;
      padding: 10px 20px;
    }
    header .logo {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    header .logo img {
      width: 32px;
      height: 32px;
      border-radius: 8px;
    }
    .user-info button {
      margin-left: 8px;
      padding: 6px 12px;
      border-radius: 6px;
    }
    .btn-primary {
      background: #fff;
      color: #0052cc;
      border: none;
    }
    .btn-outline {
      background: transparent;
      border: 1px solid white;
      color: white;
    }
    .btn-gray {
      background: #eee;
      color: #333;
      border: none;
    }
  </style>
</head>
<body>
  <!-- 🟦 Thanh điều hướng -->
  <header class="navbar">
    <div class="logo">
      <img src="/logo.jpg" alt="Logo" />
      <span>EmoBox - Gắn kết yêu thương</span>
    </div>
    <div id="user-info" class="user-info">
      <button id="loginBtn" class="btn-primary">Đăng nhập</button>
      <button id="registerBtn" class="btn-outline">Đăng ký</button>
      <button id="logoutBtn" class="btn-gray hidden">Đăng xuất</button>
    </div>
  </header>

  <!-- 🔒 Modal đăng nhập / đăng ký -->
  <div id="authModal" class="hidden">
    <div class="box">
      <h2 id="authTitle">Đăng nhập</h2>
      <input type="text" id="authUsername" placeholder="Tên đăng nhập" />
      <input type="password" id="authPassword" placeholder="Mật khẩu" />
      <button id="submitAuth" style="background:#0052cc;color:white;">Xác nhận</button>
      <button id="closeAuth" style="background:#ccc;">Đóng</button>
      <p id="switchAuth" style="margin-top:12px;font-size:14px;">
        Chưa có tài khoản?
        <a href="#" id="switchToRegister" style="color:#0052cc;text-decoration:underline;">Đăng ký ngay</a>
      </p>
    </div>
  </div>

  <!-- 🧠 Nội dung chính -->
  <main style="padding: 20px;">
    <section class="card">
      <h3>🎤 Gửi lời nhắn ngay (Realtime)</h3>
      <button id="recordBtn">🎙️ Ghi âm ngay</button>
      <button id="stopBtn">⏹️ Dừng</button>
      <input id="msgTitle" placeholder="Tiêu đề (ví dụ: Lời chúc)" />
      <button id="sendBtn">📤 Gửi ngay</button>
      <audio id="audioPlayer" controls></audio>
    </section>

    <section class="card">
      <h3>⏰ Đặt báo thức bằng giọng nói</h3>
      <input id="alarmDate" type="date" />
      <input id="alarmTime" type="time" />
      <input id="alarmTitle" placeholder="Tên báo thức (VD: Ăn sáng)" />
      <button id="alarmRecordBtn">🎙️ Ghi âm cho báo thức</button>
      <button id="alarmStopBtn">⏹️ Dừng</button>
      <button id="saveAlarmBtn">💾 Lưu báo thức</button>
      <audio id="alarmAudio" controls></audio>
    </section>

    <section class="card">
      <h3>🔔 Lịch & Tin nhắn của bạn</h3>
      <div id="alarmList"></div>
      <div id="messageList"></div>
    </section>

    <section class="card">
      <h3>📘 Hướng dẫn sử dụng</h3>
      <p>
        - Ghi âm và gửi tin nhắn: chọn "Gửi lời nhắn ngay", thu âm, nghe lại và gửi.<br />
        - Đặt báo thức bằng giọng nói: chọn ngày, giờ, ghi âm lời nhắc.<br />
        - ESP sẽ phát lại tin nhắn/báo thức khi đến giờ.<br />
        - Cần đăng nhập để lưu lịch sử và gửi voice.
      </p>
    </section>
  </main>

  <footer style="text-align:center;padding:20px;color:#555;">
    ©2025 - Mai Phước Gia Bảo - Dự án khoa học kỹ thuật
  </footer>

  <!-- 🧠 Script xử lý đăng nhập / đăng ký -->
  <script>
    const API_URL = "https://emobox-server.onrender.com";

    const loginBtn = document.getElementById("loginBtn");
    const registerBtn = document.getElementById("registerBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const modal = document.getElementById("authModal");
    const authTitle = document.getElementById("authTitle");
    const username = document.getElementById("authUsername");
    const password = document.getElementById("authPassword");
    const submitAuth = document.getElementById("submitAuth");
    const closeAuth = document.getElementById("closeAuth");
    const switchLink = document.getElementById("switchToRegister");

    let currentMode = "login"; // login / register

    // 🟢 Mở form đăng nhập
    loginBtn.addEventListener("click", () => {
      modal.classList.remove("hidden");
      authTitle.textContent = "Đăng nhập";
      currentMode = "login";
      switchLink.textContent = "Đăng ký ngay";
    });

    // 🟢 Mở form đăng ký
    registerBtn.addEventListener("click", () => {
      modal.classList.remove("hidden");
      authTitle.textContent = "Đăng ký";
      currentMode = "register";
      switchLink.textContent = "Đăng nhập ngay";
    });

    // 🔄 Chuyển giữa login/register
    switchLink.addEventListener("click", (e) => {
      e.preventDefault();
      if (currentMode === "login") {
        currentMode = "register";
        authTitle.textContent = "Đăng ký";
        switchLink.textContent = "Đăng nhập ngay";
      } else {
        currentMode = "login";
        authTitle.textContent = "Đăng nhập";
        switchLink.textContent = "Đăng ký ngay";
      }
    });

    // ❌ Đóng modal
    closeAuth.addEventListener("click", () => modal.classList.add("hidden"));

    // 📤 Gửi form đăng nhập / đăng ký
    submitAuth.addEventListener("click", async () => {
      const body = {
        username: username.value.trim(),
        password: password.value.trim(),
      };
      if (!body.username || !body.password) return alert("Vui lòng nhập đầy đủ!");

      const endpoint = currentMode === "login" ? "/auth/login" : "/auth/register";
      try {
        const res = await fetch(API_URL + endpoint, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });
        const data = await res.json();

        if (data.success) {
          alert(currentMode === "login" ? "Đăng nhập thành công!" : "Đăng ký thành công!");
          modal.classList.add("hidden");
          localStorage.setItem("token", data.token || "");
          loginBtn.classList.add("hidden");
          registerBtn.classList.add("hidden");
          logoutBtn.classList.remove("hidden");
        } else {
          alert(data.message || "Sai tài khoản hoặc mật khẩu!");
        }
      } catch (err) {
        alert("Không thể kết nối server!");
        console.error(err);
      }
    });

    // 🚪 Đăng xuất
    logoutBtn.addEventListener("click", () => {
      localStorage.removeItem("token");
      alert("Đã đăng xuất!");
      logoutBtn.classList.add("hidden");
      loginBtn.classList.remove("hidden");
      registerBtn.classList.remove("hidden");
    });

    // ✅ Kiểm tra token khi tải trang
    window.addEventListener("load", () => {
      if (localStorage.getItem("token")) {
        loginBtn.classList.add("hidden");
        registerBtn.classList.add("hidden");
        logoutBtn.classList.remove("hidden");
      }
    });
  </script>
  <script src="script.js"></script>
</body>
</html>
